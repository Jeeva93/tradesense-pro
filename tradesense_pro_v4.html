<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TradeSense Pro v4 ‚Äî Auto</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#060810;
  --surface:#0c0f1a;
  --panel:#101526;
  --border:#1e2540;
  --accent:#00f5c4;
  --accent2:#7b61ff;
  --bull:#00e676;
  --bear:#ff3d6b;
  --warn:#ffc107;
  --text:#c8d4ec;
  --muted:#5a6a8a;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:var(--bg);
  color:var(--text);
  font-family:'Rajdhani',sans-serif;
  min-height:100vh;
  overflow-x:hidden;
}
body::before{
  content:'';
  position:fixed;inset:0;
  background-image:
    linear-gradient(rgba(0,245,196,0.025) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,245,196,0.025) 1px,transparent 1px);
  background-size:44px 44px;
  pointer-events:none;z-index:0;
}
body::after{
  content:'';
  position:fixed;
  width:700px;height:700px;
  border-radius:50%;
  background:radial-gradient(circle,rgba(123,97,255,0.06) 0%,transparent 70%);
  top:-250px;right:-250px;
  pointer-events:none;z-index:0;
}
.wrapper{
  position:relative;z-index:1;
  max-width:860px;margin:0 auto;
  padding:28px 18px 70px;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{display:flex;align-items:center;gap:14px;margin-bottom:32px;}
.logo{
  width:48px;height:48px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:12px;display:grid;place-items:center;
  font-size:22px;flex-shrink:0;
  box-shadow:0 0 24px rgba(0,245,196,0.25);
}
.header-text h1{
  font-family:'Orbitron',monospace;font-size:20px;font-weight:900;letter-spacing:3px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.header-text p{font-size:11px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;font-family:'Share Tech Mono',monospace;}
.live-badge{
  margin-left:auto;display:flex;align-items:center;gap:6px;
  background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.2);
  border-radius:20px;padding:5px 12px;font-size:11px;color:var(--bull);
  font-family:'Share Tech Mono',monospace;letter-spacing:1px;
}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--bull);animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.4;transform:scale(1.5);}}

/* ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ */
.section-label{
  font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);
  font-family:'Share Tech Mono',monospace;margin-bottom:12px;
  display:flex;align-items:center;gap:8px;
}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ */
.panel{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:22px;margin-bottom:18px;
  position:relative;overflow:hidden;
}
.panel::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0.35;
}

/* ‚îÄ‚îÄ AUTO FETCH CARD ‚îÄ‚îÄ */
.fetch-card{
  display:flex;flex-direction:column;gap:16px;
}
.fetch-status-row{
  display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
}
@media(max-width:560px){.fetch-status-row{grid-template-columns:1fr 1fr;}}
.fetch-item{
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;
  display:flex;flex-direction:column;gap:4px;
  transition:border-color 0.3s;
}
.fetch-item.loaded{border-color:rgba(0,230,118,0.3);}
.fetch-item.error{border-color:rgba(255,61,107,0.3);}
.fi-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);font-family:'Share Tech Mono',monospace;}
.fi-value{
  font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:var(--text);
  min-height:24px;display:flex;align-items:center;
}
.fi-value.loading{color:var(--muted);}
.fi-value.green{color:var(--bull);}
.fi-value.red{color:var(--bear);}
.fi-sub{font-size:11px;color:var(--muted);font-family:'Share Tech Mono',monospace;min-height:14px;}

/* ‚îÄ‚îÄ SHIMMER ‚îÄ‚îÄ */
.shimmer{
  width:70%;height:18px;border-radius:4px;
  background:linear-gradient(90deg,var(--border) 25%,#1e2e40 50%,var(--border) 75%);
  background-size:200% 100%;
  animation:shimmer 1.2s infinite;
}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}

/* ‚îÄ‚îÄ FETCH BUTTON ‚îÄ‚îÄ */
.btn-fetch{
  width:100%;padding:14px;
  background:var(--surface);border:1px solid var(--accent);
  border-radius:10px;font-family:'Orbitron',monospace;font-size:12px;font-weight:700;
  letter-spacing:2px;color:var(--accent);cursor:pointer;
  transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;
}
.btn-fetch:hover{background:rgba(0,245,196,0.08);box-shadow:0 0 20px rgba(0,245,196,0.15);}
.btn-fetch:disabled{opacity:0.5;cursor:not-allowed;}

/* spinning icon */
.spin{display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ‚îÄ‚îÄ SENTIMENT TOGGLES ‚îÄ‚îÄ */
.selector-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
@media(max-width:560px){.selector-grid{grid-template-columns:1fr 1fr;}}
.chip-group{display:flex;flex-direction:column;gap:6px;}
.chip-group label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);font-family:'Share Tech Mono',monospace;}
.chips{display:flex;gap:5px;flex-wrap:wrap;}
.chip{
  padding:5px 9px;border-radius:6px;font-size:12px;font-weight:600;
  font-family:'Rajdhani',sans-serif;cursor:pointer;
  border:1px solid var(--border);background:var(--surface);color:var(--muted);
  transition:all 0.15s;user-select:none;letter-spacing:0.5px;
}
.chip:hover{border-color:var(--accent);color:var(--text);}
.chip.active-bull{background:rgba(0,230,118,0.12);border-color:var(--bull);color:var(--bull);}
.chip.active-bear{background:rgba(255,61,107,0.12);border-color:var(--bear);color:var(--bear);}
.chip.active-neu{background:rgba(255,193,7,0.12);border-color:var(--warn);color:var(--warn);}

/* ‚îÄ‚îÄ PCR MANUAL INPUT ‚îÄ‚îÄ */
.manual-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
@media(max-width:400px){.manual-row{grid-template-columns:1fr;}}
.field{display:flex;flex-direction:column;gap:6px;}
.field label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);font-family:'Share Tech Mono',monospace;}
.field input{
  background:var(--surface);border:1px solid var(--border);border-radius:8px;
  padding:10px 14px;color:var(--text);font-family:'Rajdhani',sans-serif;
  font-size:15px;font-weight:600;outline:none;transition:border-color 0.2s,box-shadow 0.2s;
}
.field input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,245,196,0.1);}

/* ‚îÄ‚îÄ AI ANALYSIS BUTTON ‚îÄ‚îÄ */
.btn-analyse{
  width:100%;padding:16px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none;border-radius:10px;
  font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:3px;
  color:#000;cursor:pointer;transition:opacity 0.2s,transform 0.15s,box-shadow 0.2s;
  box-shadow:0 0 30px rgba(0,245,196,0.2);position:relative;overflow:hidden;
}
.btn-analyse:hover{opacity:0.92;transform:translateY(-1px);box-shadow:0 0 40px rgba(0,245,196,0.35);}
.btn-analyse:active{transform:translateY(0);}
.btn-analyse:disabled{opacity:0.5;cursor:not-allowed;}
.btn-analyse::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.15) 50%,transparent 100%);
  transform:translateX(-100%);transition:transform 0.4s;
}
.btn-analyse:hover::after{transform:translateX(100%);}

/* ‚îÄ‚îÄ OUTPUT ‚îÄ‚îÄ */
#output-panel{display:none;animation:fadeUp 0.4s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ AI RESPONSE CARD ‚îÄ‚îÄ */
.ai-response{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:24px;margin-bottom:18px;
  position:relative;overflow:hidden;
}
.ai-response::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--accent2),transparent);opacity:0.4;
}
.ai-header{
  display:flex;align-items:center;gap:10px;margin-bottom:16px;
  padding-bottom:14px;border-bottom:1px solid var(--border);
}
.ai-avatar{
  width:32px;height:32px;border-radius:8px;
  background:linear-gradient(135deg,var(--accent2),var(--accent));
  display:grid;place-items:center;font-size:15px;flex-shrink:0;
}
.ai-title{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:2px;color:var(--accent2);}
.ai-sub{font-size:11px;color:var(--muted);font-family:'Share Tech Mono',monospace;}

/* Streaming text */
#ai-text{
  font-size:14px;line-height:1.8;color:var(--text);font-weight:500;
  white-space:pre-wrap;min-height:40px;
}

.cursor{
  display:inline-block;width:2px;height:16px;
  background:var(--accent);margin-left:2px;vertical-align:middle;
  animation:blink 0.7s infinite;
}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}

/* ‚îÄ‚îÄ SIGNAL CARD ‚îÄ‚îÄ */
.signal-card{
  border-radius:14px;padding:24px;margin-bottom:18px;
  position:relative;overflow:hidden;border:1px solid;
}
.signal-card.bull{background:linear-gradient(135deg,rgba(0,230,118,0.07),rgba(0,230,118,0.02));border-color:rgba(0,230,118,0.3);}
.signal-card.bear{background:linear-gradient(135deg,rgba(255,61,107,0.07),rgba(255,61,107,0.02));border-color:rgba(255,61,107,0.3);}
.signal-card.wait{background:linear-gradient(135deg,rgba(255,193,7,0.07),rgba(255,193,7,0.02));border-color:rgba(255,193,7,0.3);}

.signal-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.signal-name{font-family:'Orbitron',monospace;font-size:26px;font-weight:900;letter-spacing:2px;}
.signal-name.bull{color:var(--bull);}
.signal-name.bear{color:var(--bear);}
.signal-name.wait{color:var(--warn);}
.conf-label{font-size:10px;letter-spacing:2px;color:var(--muted);font-family:'Share Tech Mono',monospace;text-transform:uppercase;margin-bottom:4px;}
.conf-value{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:1px;}
.conf-value.strong{color:var(--bull);}
.conf-value.moderate{color:var(--warn);}
.conf-value.low{color:var(--muted);}

/* Score bar */
.score-row{display:flex;align-items:center;gap:10px;margin-bottom:18px;}
.score-lab{font-size:10px;font-family:'Share Tech Mono',monospace;color:var(--muted);width:35px;}
.score-track{flex:1;height:8px;background:var(--surface);border-radius:20px;position:relative;overflow:hidden;border:1px solid var(--border);}
.score-fill-bull{position:absolute;left:50%;top:0;bottom:0;background:linear-gradient(90deg,var(--bull),#00ffaa);border-radius:0 20px 20px 0;transition:width 0.7s cubic-bezier(0.4,0,0.2,1);}
.score-fill-bear{position:absolute;right:50%;top:0;bottom:0;background:linear-gradient(270deg,var(--bear),#ff8a00);border-radius:20px 0 0 20px;transition:width 0.7s cubic-bezier(0.4,0,0.2,1);}
.score-center{position:absolute;left:50%;transform:translateX(-50%);top:0;bottom:0;width:2px;background:var(--muted);}

/* Details */
.details-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px;}
@media(max-width:480px){.details-grid{grid-template-columns:1fr 1fr;}}
.detail-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;display:flex;flex-direction:column;gap:4px;}
.d-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);font-family:'Share Tech Mono',monospace;}
.d-value{font-size:17px;font-weight:700;font-family:'Orbitron',monospace;color:var(--text);}
.d-value.green{color:var(--bull);}
.d-value.red{color:var(--bear);}
.d-value.yellow{color:var(--warn);}

/* Breakdown */
.breakdown{display:flex;flex-direction:column;gap:7px;}
.breakdown-row{
  display:flex;align-items:center;gap:10px;padding:8px 12px;
  background:var(--surface);border-radius:8px;border:1px solid var(--border);
}
.br-icon{font-size:14px;width:20px;text-align:center;}
.br-name{flex:1;font-size:13px;font-weight:600;color:var(--text);}
.br-score{font-family:'Share Tech Mono',monospace;font-size:11px;padding:2px 8px;border-radius:4px;font-weight:600;}
.br-score.pos{background:rgba(0,230,118,0.1);color:var(--bull);}
.br-score.neg{background:rgba(255,61,107,0.1);color:var(--bear);}
.br-score.neu{background:rgba(255,193,7,0.1);color:var(--warn);}
.br-score.zero{background:var(--border);color:var(--muted);}

/* Tips */
.tips-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:480px){.tips-grid{grid-template-columns:1fr;}}
.tip-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:13px 15px;display:flex;gap:10px;}
.tip-icon{font-size:18px;margin-top:2px;}
.tip-title{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);font-family:'Share Tech Mono',monospace;margin-bottom:4px;}
.tip-body-text{font-size:13px;font-weight:500;line-height:1.5;color:var(--text);}

/* Error banner */
.error-banner{
  background:rgba(255,61,107,0.08);border:1px solid rgba(255,61,107,0.3);
  border-radius:10px;padding:14px 16px;font-size:13px;color:var(--bear);
  font-family:'Share Tech Mono',monospace;line-height:1.6;margin-bottom:14px;
}

.disclaimer{
  text-align:center;font-size:11px;color:var(--muted);
  font-family:'Share Tech Mono',monospace;margin-top:30px;
  letter-spacing:1px;line-height:1.8;padding:0 20px;
}

/* timestamp */
.timestamp{font-size:10px;color:var(--muted);font-family:'Share Tech Mono',monospace;text-align:right;margin-top:6px;}
</style>
</head>
<body>
<div class="wrapper">

  <!-- HEADER -->
  <header>
    <div class="logo">üì°</div>
    <div class="header-text">
      <h1>TRADESENSE PRO</h1>
      <p>Auto-Intelligence Engine ¬∑ v4.0</p>
    </div>
    <div class="live-badge"><div class="live-dot"></div>AUTO</div>
  </header>

  <!-- STEP 1: LIVE DATA FETCH -->
  <div class="section-label">Step 1 ‚Äî Live Market Data</div>
  <div class="panel">
    <div class="fetch-card">
      <div class="fetch-status-row">
        <div class="fetch-item" id="fi-price">
          <div class="fi-label">Nifty 50</div>
          <div class="fi-value loading" id="fv-price"><div class="shimmer"></div></div>
          <div class="fi-sub" id="fs-price">‚Äî</div>
        </div>
        <div class="fetch-item" id="fi-vwap">
          <div class="fi-label">VWAP</div>
          <div class="fi-value loading" id="fv-vwap"><div class="shimmer"></div></div>
          <div class="fi-sub" id="fs-vwap">‚Äî</div>
        </div>
        <div class="fetch-item" id="fi-rsi">
          <div class="fi-label">RSI (14)</div>
          <div class="fi-value loading" id="fv-rsi"><div class="shimmer"></div></div>
          <div class="fi-sub" id="fs-rsi">‚Äî</div>
        </div>
        <div class="fetch-item" id="fi-vix">
          <div class="fi-label">India VIX</div>
          <div class="fi-value loading" id="fv-vix"><div class="shimmer"></div></div>
          <div class="fi-sub" id="fs-vix">‚Äî</div>
        </div>
      </div>
      <div id="error-banner" class="error-banner" style="display:none"></div>
      <div class="timestamp" id="fetch-time"></div>
      <button class="btn-fetch" id="btn-fetch" onclick="fetchLiveData()">
        <span id="fetch-icon">üîÑ</span> FETCH LIVE DATA
      </button>
    </div>
  </div>

  <!-- STEP 2: MANUAL INPUTS -->
  <div class="section-label">Step 2 ‚Äî Manual Inputs</div>
  <div class="panel">
    <div class="manual-row">
      <div class="field">
        <label>PCR (Put-Call Ratio)</label>
        <input type="number" id="pcr" placeholder="e.g. 1.20" step="0.01"/>
      </div>
      <div class="field">
        <label>Prev Close</label>
        <input type="number" id="prev" placeholder="e.g. 25600" step="0.5"/>
      </div>
    </div>

    <div class="section-label" style="margin-top:4px;">Market Sentiment</div>
    <div class="selector-grid">
      <div class="chip-group">
        <label>OI Direction</label>
        <div class="chips" id="oi-chips">
          <div class="chip" onclick="setChip('oi','long',this,'bull')">Long Build</div>
          <div class="chip" onclick="setChip('oi','short',this,'bear')">Short Build</div>
          <div class="chip" onclick="setChip('oi','shortcov',this,'bull')">Short Cover</div>
          <div class="chip" onclick="setChip('oi','longuw',this,'bear')">Long Unwind</div>
        </div>
      </div>
      <div class="chip-group">
        <label>VIX Direction</label>
        <div class="chips" id="vixdir-chips">
          <div class="chip" onclick="setChip('vixdir','rising',this,'bear')">Rising</div>
          <div class="chip" onclick="setChip('vixdir','falling',this,'bull')">Falling</div>
        </div>
      </div>
      <div class="chip-group">
        <label>15m Trend</label>
        <div class="chips" id="t15-chips">
          <div class="chip" onclick="setChip('t15','bull',this,'bull')">üü¢ Bull</div>
          <div class="chip" onclick="setChip('t15','bear',this,'bear')">üî¥ Bear</div>
          <div class="chip" onclick="setChip('t15','side',this,'neu')">‚ö™ Side</div>
        </div>
      </div>
      <div class="chip-group">
        <label>1H Trend</label>
        <div class="chips" id="t1h-chips">
          <div class="chip" onclick="setChip('t1h','bull',this,'bull')">üü¢ Bull</div>
          <div class="chip" onclick="setChip('t1h','bear',this,'bear')">üî¥ Bear</div>
          <div class="chip" onclick="setChip('t1h','side',this,'neu')">‚ö™ Side</div>
        </div>
      </div>
    </div>

    <button class="btn-analyse" id="btn-analyse" onclick="runAnalysis()">‚ö° AI ANALYSE SETUP</button>
  </div>

  <!-- OUTPUT -->
  <div id="output-panel">

    <!-- AI Insight -->
    <div class="section-label">AI Market Intelligence</div>
    <div class="ai-response">
      <div class="ai-header">
        <div class="ai-avatar">ü§ñ</div>
        <div>
          <div class="ai-title">TRADESENSE AI</div>
          <div class="ai-sub" id="ai-model-tag">Powered by Claude</div>
        </div>
      </div>
      <div id="ai-text"></div>
      <span class="cursor" id="cursor" style="display:none"></span>
    </div>

    <!-- Signal Card -->
    <div class="section-label">Signal Output</div>
    <div class="signal-card" id="signal-card">
      <div class="signal-top">
        <div>
          <div style="font-size:11px;letter-spacing:2px;color:var(--muted);font-family:'Share Tech Mono',monospace;margin-bottom:6px;">RECOMMENDED ACTION</div>
          <div class="signal-name" id="sig-name">‚Äî</div>
        </div>
        <div>
          <div class="conf-label">Confidence</div>
          <div class="conf-value" id="sig-conf">‚Äî</div>
        </div>
      </div>
      <div class="score-row">
        <div class="score-lab" style="color:var(--bear);font-size:10px;">BEAR</div>
        <div class="score-track">
          <div class="score-fill-bear" id="bar-bear" style="width:0%"></div>
          <div class="score-fill-bull" id="bar-bull" style="width:0%"></div>
          <div class="score-center"></div>
        </div>
        <div class="score-lab" style="color:var(--bull);font-size:10px;text-align:left;">BULL</div>
      </div>
      <div class="details-grid">
        <div class="detail-box"><div class="d-label">Bull Score</div><div class="d-value green" id="d-bull">‚Äî</div></div>
        <div class="detail-box"><div class="d-label">Bear Score</div><div class="d-value red" id="d-bear">‚Äî</div></div>
        <div class="detail-box"><div class="d-label">Net Edge</div><div class="d-value" id="d-diff">‚Äî</div></div>
        <div class="detail-box"><div class="d-label">Suggested Strike</div><div class="d-value" id="d-strike">‚Äî</div></div>
        <div class="detail-box"><div class="d-label">Option Type</div><div class="d-value" id="d-type">‚Äî</div></div>
        <div class="detail-box"><div class="d-label">Trade Grade</div><div class="d-value" id="d-grade">‚Äî</div></div>
      </div>
    </div>

    <!-- Breakdown -->
    <div class="section-label">Score Breakdown</div>
    <div class="panel"><div class="breakdown" id="breakdown"></div></div>

    <!-- Tips -->
    <div class="section-label">Strategy Intelligence</div>
    <div class="panel"><div class="tips-grid" id="tips-grid"></div></div>

  </div>

  <div class="disclaimer">
    ‚ö†Ô∏è FOR EDUCATIONAL PURPOSES ONLY ¬∑ NOT SEBI REGISTERED ADVICE<br/>
    Live data via open APIs ‚Äî may have slight delay. Always verify before trading.
  </div>
</div>

<script>
/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
const S = { oi:null, vixdir:null, t15:null, t1h:null };
const liveData = { price:null, vwap:null, rsi:null, vix:null };

function setChip(key, val, el, cls) {
  S[key] = val;
  const ids = {oi:'oi-chips',vixdir:'vixdir-chips',t15:'t15-chips',t1h:'t1h-chips'};
  document.getElementById(ids[key]).querySelectorAll('.chip').forEach(c=>c.classList.remove('active-bull','active-bear','active-neu'));
  el.classList.add(`active-${cls}`);
}

/* ‚îÄ‚îÄ LIVE DATA FETCH ‚îÄ‚îÄ */
async function fetchLiveData() {
  const btn = document.getElementById('btn-fetch');
  const icon = document.getElementById('fetch-icon');
  btn.disabled = true;
  icon.innerHTML = '<span class="spin">‚ü≥</span>';
  hideError();

  // Reset UI
  ['price','vwap','rsi','vix'].forEach(k => {
    document.getElementById(`fv-${k}`).innerHTML = '<div class="shimmer"></div>';
    document.getElementById(`fs-${k}`).textContent = '‚Äî';
    document.getElementById(`fi-${k}`).className = 'fetch-item';
  });

  try {
    // Use Yahoo Finance via allorigins proxy for Nifty 50
    const [niftyRes, vixRes] = await Promise.all([
      fetch('https://query1.finance.yahoo.com/v8/finance/chart/%5ENSEI?interval=10m&range=1d'),
      fetch('https://query1.finance.yahoo.com/v8/finance/chart/%5EINDIAVIX?interval=1d&range=1d')
    ]);

    if (!niftyRes.ok || !vixRes.ok) throw new Error('API error');

    const niftyJson = await niftyRes.json();
    const vixJson   = await vixRes.json();

    // Parse Nifty
    const chart   = niftyJson.chart.result[0];
    const meta    = chart.meta;
    const closes  = chart.indicators.quote[0].close;
    const highs   = chart.indicators.quote[0].high;
    const lows    = chart.indicators.quote[0].low;
    const volumes = chart.indicators.quote[0].volume;

    const validCloses = closes.filter(Boolean);
    const price = meta.regularMarketPrice || validCloses[validCloses.length - 1];
    const prevClose = meta.previousClose || meta.chartPreviousClose;

    // VWAP calculation (typical price √ó volume / cumulative volume)
    let cumTPV = 0, cumVol = 0;
    for (let i = 0; i < closes.length; i++) {
      if (!closes[i] || !volumes[i]) continue;
      const tp = (closes[i] + (highs[i]||closes[i]) + (lows[i]||closes[i])) / 3;
      cumTPV += tp * volumes[i];
      cumVol += volumes[i];
    }
    const vwap = cumVol > 0 ? cumTPV / cumVol : price;

    // RSI 14
    const rsi = calcRSI(validCloses, 14);

    // VIX
    const vixChart = vixJson.chart.result[0];
    const vix = vixChart.meta.regularMarketPrice;

    // Store
    liveData.price = price;
    liveData.vwap  = vwap;
    liveData.rsi   = rsi;
    liveData.vix   = vix;

    // Auto-fill prev close
    if (prevClose && !document.getElementById('prev').value) {
      document.getElementById('prev').value = prevClose.toFixed(2);
    }

    // Update UI
    setFetchItem('price', price.toFixed(2), price > prevClose ? `‚ñ≤ vs ${prevClose?.toFixed(2)}` : `‚ñº vs ${prevClose?.toFixed(2)}`, price >= prevClose ? 'green' : 'red');
    setFetchItem('vwap',  vwap.toFixed(2),  price > vwap ? `Price ${(price-vwap).toFixed(1)} above` : `Price ${(vwap-price).toFixed(1)} below`, price >= vwap ? 'green' : 'red');
    setFetchItem('rsi',   rsi.toFixed(1),   rsi > 55 ? 'Bullish zone' : rsi < 45 ? 'Bearish zone' : 'Neutral', rsi > 55 ? 'green' : rsi < 45 ? 'red' : '');
    setFetchItem('vix',   vix.toFixed(2),   vix > 20 ? 'Elevated ‚ö†Ô∏è' : 'Calm ‚úì', vix > 20 ? 'red' : 'green');

    document.getElementById('fetch-time').textContent = `Last fetched: ${new Date().toLocaleTimeString('en-IN')}`;

  } catch(e) {
    showError(`‚ö†Ô∏è Live fetch failed: ${e.message}\n\nThis may be due to CORS restrictions when opening locally. Try opening in a web server, or enter data manually below.`);
    // Show manual fallbacks
    ['price','vwap','rsi','vix'].forEach(k => {
      document.getElementById(`fv-${k}`).textContent = '‚Äî';
      document.getElementById(`fi-${k}`).classList.add('error');
    });
  }

  btn.disabled = false;
  icon.textContent = 'üîÑ';
}

function setFetchItem(key, val, sub, cls) {
  const el = document.getElementById(`fv-${key}`);
  el.innerHTML = '';
  el.textContent = val;
  el.className = `fi-value ${cls}`;
  document.getElementById(`fs-${key}`).textContent = sub;
  document.getElementById(`fi-${key}`).className = 'fetch-item loaded';
}

function calcRSI(closes, period) {
  if (closes.length < period + 1) return 50;
  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    const diff = closes[i] - closes[i - 1];
    if (diff > 0) gains += diff; else losses += Math.abs(diff);
  }
  let avgGain = gains / period;
  let avgLoss = losses / period;
  for (let i = period + 1; i < closes.length; i++) {
    const diff = closes[i] - closes[i - 1];
    avgGain = (avgGain * (period - 1) + Math.max(diff, 0)) / period;
    avgLoss = (avgLoss * (period - 1) + Math.max(-diff, 0)) / period;
  }
  if (avgLoss === 0) return 100;
  const rs = avgGain / avgLoss;
  return 100 - 100 / (1 + rs);
}

function showError(msg) {
  const b = document.getElementById('error-banner');
  b.style.display = 'block';
  b.textContent = msg;
}
function hideError() {
  document.getElementById('error-banner').style.display = 'none';
}

/* ‚îÄ‚îÄ ANALYSIS ENGINE ‚îÄ‚îÄ */
function calcScores() {
  const price = liveData.price || 0;
  const vwap  = liveData.vwap  || 0;
  const rsi   = liveData.rsi   || 0;
  const vix   = liveData.vix   || 0;
  const prev  = +document.getElementById('prev').value;
  const pcr   = +document.getElementById('pcr').value;
  const { oi, vixdir, t15, t1h } = S;

  let bull = 0, bear = 0;
  const breakdown = [];

  // VWAP
  const vwapGap = vwap ? ((price - vwap) / vwap * 100).toFixed(2) : 0;
  if (price > vwap) { bull += 2.5; breakdown.push({icon:'üìä',name:`Above VWAP (+${vwapGap}%)`,bull:2.5,bear:0}); }
  else              { bear += 2.5; breakdown.push({icon:'üìä',name:`Below VWAP (${vwapGap}%)`,bull:0,bear:2.5}); }

  // Prev Close
  if (prev) {
    const gap = ((price-prev)/prev*100).toFixed(2);
    if (price > prev) { bull += 1; breakdown.push({icon:'üìà',name:`Gap Up vs Prev Close (+${gap}%)`,bull:1,bear:0}); }
    else              { bear += 1; breakdown.push({icon:'üìâ',name:`Gap Down vs Prev Close (${gap}%)`,bull:0,bear:1}); }
  }

  // RSI
  let rb=0,rs=0,rn='';
  if (rsi>65){rb=2;rn=`RSI Overbought (${rsi.toFixed(1)}) ‚Äî Strong momentum`;}
  else if(rsi>55){rb=1.5;rn=`RSI Bullish (${rsi.toFixed(1)})`;}
  else if(rsi>=45){rn=`RSI Neutral (${rsi.toFixed(1)})`;}
  else if(rsi>=35){rs=1.5;rn=`RSI Bearish (${rsi.toFixed(1)})`;}
  else{rs=2;rn=`RSI Oversold (${rsi.toFixed(1)}) ‚Äî Bearish pressure`;}
  bull+=rb;bear+=rs;breakdown.push({icon:'üì°',name:rn,bull:rb,bear:rs});

  // PCR
  if (pcr) {
    let pb=0,ps=0,pn='';
    if(pcr>1.5){pb=1.5;pn=`PCR Extremely Bullish (${pcr})`;}
    else if(pcr>1.2){pb=1;pn=`PCR Bullish (${pcr})`;}
    else if(pcr>=0.85){pn=`PCR Neutral (${pcr})`;}
    else if(pcr>=0.6){ps=1;pn=`PCR Bearish (${pcr})`;}
    else{ps=1.5;pn=`PCR Extremely Bearish (${pcr})`;}
    bull+=pb;bear+=ps;breakdown.push({icon:'‚öñÔ∏è',name:pn,bull:pb,bear:ps});
  }

  // OI
  if (oi) {
    const m={long:{b:3,s:0,n:'Long Buildup ‚Äî Bulls adding'},short:{b:0,s:3,n:'Short Buildup ‚Äî Bears adding'},shortcov:{b:1.5,s:0,n:'Short Covering ‚Äî Squeeze risk'},longuw:{b:0,s:1.5,n:'Long Unwinding ‚Äî Bulls reducing'}};
    const d=m[oi]; bull+=d.b;bear+=d.s;breakdown.push({icon:'üì¶',name:d.n,bull:d.b,bear:d.s});
  }

  // VIX
  let vb=0,vs=0,vn='';
  if(vix>25){vs+=1.5;vn=`VIX Extreme Fear (${vix?.toFixed(1)}) ‚Äî High risk`;}
  else if(vix>18){vs+=0.75;vn=`VIX Elevated (${vix?.toFixed(1)}) ‚Äî Caution`;}
  else{vn=`VIX Calm (${vix?.toFixed(1)}) ‚Äî Good conditions`;}
  if(vixdir==='rising'){vs+=1;vn+=' ¬∑ Rising';}
  else if(vixdir==='falling'){vb+=0.5;vn+=' ¬∑ Falling';}
  bull+=vb;bear+=vs;breakdown.push({icon:'üå°Ô∏è',name:vn,bull:vb,bear:vs});

  // Trend
  let tb=0,ts=0,tn='';
  if(t15==='bull'&&t1h==='bull'){tb=2;tn='15m + 1H Both Bullish ‚Äî Strong confluence';}
  else if(t15==='bear'&&t1h==='bear'){ts=2;tn='15m + 1H Both Bearish ‚Äî Strong confluence';}
  else{tn=`Mixed Timeframes (15m:${t15||'?'}, 1H:${t1h||'?'}) ‚Äî No confluence`;bear+=0.5;}
  bull+=tb;bear+=ts;breakdown.push({icon:'üìê',name:tn,bull:tb,bear:ts});

  return { bull, bear, diff: bull-bear, breakdown, price };
}

async function runAnalysis() {
  const price = liveData.price;
  const pcr   = +document.getElementById('pcr').value;
  const { oi, vixdir, t15, t1h } = S;

  if (!price) { alert('‚ö†Ô∏è Please fetch live data first.'); return; }
  if (!pcr)   { alert('‚ö†Ô∏è Please enter PCR value.'); return; }
  if (!oi||!vixdir||!t15||!t1h) { alert('‚ö†Ô∏è Please select all sentiment toggles.'); return; }

  const { bull, bear, diff, breakdown } = calcScores();

  // Determine signal
  let signal, direction, confText, confClass, cardClass, strike, optType, grade;
  if (Math.abs(diff) < 1.5) {
    signal='WAIT / AVOID';direction='Neutral';confText='NO TRADE';confClass='low';cardClass='wait';strike='‚Äî';optType='‚Äî';grade='‚ùå Skip';
  } else if (diff >= 6) {
    signal='BUY CALL';direction='Strongly Bullish';confText='STRONG';confClass='strong';cardClass='bull';optType='CALL';
    strike=Math.floor(price/100)*100;grade='‚≠ê Premium Setup';
  } else if (diff >= 3) {
    signal='BUY CALL';direction='Bullish';confText='MODERATE';confClass='moderate';cardClass='bull';optType='CALL';
    strike=Math.ceil(price/100)*100;grade='‚úÖ Good Setup';
  } else if (diff <= -6) {
    signal='BUY PUT';direction='Strongly Bearish';confText='STRONG';confClass='strong';cardClass='bear';optType='PUT';
    strike=Math.ceil(price/100)*100;grade='‚≠ê Premium Setup';
  } else if (diff <= -3) {
    signal='BUY PUT';direction='Bearish';confText='MODERATE';confClass='moderate';cardClass='bear';optType='PUT';
    strike=Math.floor(price/100)*100;grade='‚úÖ Good Setup';
  } else {
    signal='WEAK SIGNAL';direction='Unclear';confText='LOW';confClass='low';cardClass='wait';strike='Caution';optType='‚Äî';grade='‚ö†Ô∏è Low Conviction';
  }

  // Show output panel
  document.getElementById('output-panel').style.display = 'block';
  document.getElementById('output-panel').scrollIntoView({behavior:'smooth',block:'start'});

  // Render signal card
  const card = document.getElementById('signal-card');
  card.className = `signal-card ${cardClass}`;
  const sn = document.getElementById('sig-name');
  sn.textContent = signal; sn.className = `signal-name ${cardClass}`;
  const sc = document.getElementById('sig-conf');
  sc.textContent = confText; sc.className = `conf-value ${confClass}`;

  const maxS = 14;
  document.getElementById('bar-bull').style.width = Math.min((bull/maxS)*50,50)+'%';
  document.getElementById('bar-bear').style.width = Math.min((bear/maxS)*50,50)+'%';

  document.getElementById('d-bull').textContent = bull.toFixed(1);
  document.getElementById('d-bear').textContent = bear.toFixed(1);
  const dd = document.getElementById('d-diff');
  dd.textContent = (diff>0?'+':'')+diff.toFixed(1);
  dd.className = 'd-value '+(diff>0?'green':diff<0?'red':'');
  document.getElementById('d-strike').textContent = strike;
  const dt = document.getElementById('d-type');
  dt.textContent = optType;
  dt.className = 'd-value '+(optType==='CALL'?'green':optType==='PUT'?'red':'');
  document.getElementById('d-grade').textContent = grade;

  // Breakdown
  document.getElementById('breakdown').innerHTML = breakdown.map(r => {
    let lbl, cls;
    if(r.bull>0&&r.bear===0){lbl=`+${r.bull} BULL`;cls='pos';}
    else if(r.bear>0&&r.bull===0){lbl=`-${r.bear} BEAR`;cls='neg';}
    else if(r.bull===0&&r.bear===0){lbl='NEUTRAL';cls='zero';}
    else{lbl='¬±MIXED';cls='neu';}
    return `<div class="breakdown-row"><div class="br-icon">${r.icon}</div><div class="br-name">${r.name}</div><div class="br-score ${cls}">${lbl}</div></div>`;
  }).join('');

  // Tips
  const tips = buildTips(cardClass, liveData.vix, liveData.rsi, diff, price, strike, optType);
  document.getElementById('tips-grid').innerHTML = tips.map(t =>
    `<div class="tip-card"><div class="tip-icon">${t.icon}</div><div><div class="tip-title">${t.title}</div><div class="tip-body-text">${t.body}</div></div></div>`
  ).join('');

  // AI Streaming Analysis
  await streamAIAnalysis({ price, vwap: liveData.vwap, rsi: liveData.rsi, vix: liveData.vix, pcr, bull, bear, diff, signal, direction, confText, optType, strike, oi, vixdir, t15, t1h });
}

/* ‚îÄ‚îÄ AI STREAMING ‚îÄ‚îÄ */
async function streamAIAnalysis(data) {
  const textEl = document.getElementById('ai-text');
  const cursor = document.getElementById('cursor');
  textEl.textContent = '';
  cursor.style.display = 'inline-block';

  const prompt = `You are TradeSense AI, an expert Indian options trader analyzing Nifty 50.

Current Market Data:
- Nifty 50 Price: ${data.price?.toFixed(2)}
- VWAP: ${data.vwap?.toFixed(2)} (Price is ${data.price > data.vwap ? 'ABOVE' : 'BELOW'} VWAP)
- RSI (14): ${data.rsi?.toFixed(1)}
- India VIX: ${data.vix?.toFixed(2)} (${data.vixdir === 'rising' ? 'Rising' : 'Falling'})
- PCR: ${data.pcr}
- OI Direction: ${data.oi}
- 15m Trend: ${data.t15} | 1H Trend: ${data.t1h}

Strategy Engine Output:
- Signal: ${data.signal}
- Direction: ${data.direction}
- Confidence: ${data.confText}
- Bull Score: ${data.bull.toFixed(1)} | Bear Score: ${data.bear.toFixed(1)} | Net Edge: ${data.diff.toFixed(1)}
- Suggested: ${data.optType} at ${data.strike}

Give a sharp, concise 4-5 line market analysis. Include: what the current setup means, key risk to watch, and one actionable tip. Be direct, like an experienced trader. No fluff. Use ‚Çπ for rupees.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 300,
        stream: true,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) throw new Error('AI unavailable');

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6);
        if (data === '[DONE]') continue;
        try {
          const json = JSON.parse(data);
          if (json.type === 'content_block_delta' && json.delta?.text) {
            textEl.textContent += json.delta.text;
          }
        } catch {}
      }
    }
  } catch(e) {
    // Fallback local analysis
    const fallback = generateFallbackInsight(data);
    for (const char of fallback) {
      textEl.textContent += char;
      await new Promise(r => setTimeout(r, 12));
    }
  }

  cursor.style.display = 'none';
}

function generateFallbackInsight(d) {
  const dir = d.diff > 0 ? 'bullish' : d.diff < 0 ? 'bearish' : 'neutral';
  const vwapPos = d.price > d.vwap ? 'above' : 'below';
  const rsiZone = d.rsi > 60 ? 'bullish momentum territory' : d.rsi < 40 ? 'bearish oversold zone' : 'neutral ground';

  return `Nifty is trading ${vwapPos} VWAP at ‚Çπ${d.price?.toFixed(0)}, indicating ${d.price > d.vwap ? 'intraday buying strength' : 'selling pressure dominates'}. RSI at ${d.rsi?.toFixed(1)} is in ${rsiZone}${d.rsi > 65 ? ' ‚Äî be cautious of pullbacks' : d.rsi < 35 ? ' ‚Äî watch for reversal signals' : ''}.

VIX at ${d.vix?.toFixed(1)} is ${d.vix > 20 ? 'elevated ‚Äî options premiums are rich, prefer spreads or reduce position size' : 'calm ‚Äî straightforward options buying is cost-effective today'}.

Net edge score of ${d.diff > 0 ? '+' : ''}${d.diff?.toFixed(1)} gives a ${d.confText?.toLowerCase()} ${dir} signal. ${Math.abs(d.diff) >= 6 ? 'Multiple factors align ‚Äî this is a quality setup worth taking with defined risk.' : Math.abs(d.diff) >= 3 ? 'Decent setup but not all factors confirm ‚Äî trade smaller size and keep tight stops.' : 'Conflicting signals ‚Äî better to stay on the sidelines and wait for cleaner confluence.'}`;
}

function buildTips(dir, vix, rsi, diff, price, strike, optType) {
  const tips = [];
  if (dir === 'wait') {
    tips.push({icon:'‚è∏Ô∏è',title:'Patience Is a Position',body:'Too many conflicting signals. Wait for VWAP reclaim or RSI to break 55/45 with OI confirmation.'});
    tips.push({icon:'üìñ',title:'What to Watch',body:'Monitor for fresh long buildup on OI, VIX direction change, and a clean 15m candle close above/below VWAP.'});
    return tips;
  }
  const isBull = optType === 'CALL';
  tips.push({icon:isBull?'üü¢':'üî¥',title:'Entry Strategy',body:`Enter ${optType} at strike ${strike}. ${isBull?'Buy on dips to VWAP for better risk:reward.':'Enter on pullback rallies for cheaper premium.'}`});
  tips.push({icon:'üõ°Ô∏è',title:'Stop-Loss',body:isBull?'Cut if price closes below VWAP on a 10m candle. Option SL: -25% from entry premium.':'Cut if price reclaims VWAP on 10m close. Option SL: -25% from entry premium.'});
  tips.push({icon:'üå°Ô∏è',title:'VIX Context',body:vix>20?`VIX ${vix?.toFixed(1)} is high ‚Äî buy spreads instead of naked options to cap cost.`:`VIX ${vix?.toFixed(1)} is low ‚Äî direct option buying is fine, premiums are reasonable.`});
  tips.push({icon:'üì°',title:'RSI Context',body:rsi>65?`RSI ${rsi?.toFixed(1)} is overbought ‚Äî trail stop tightly, don't chase.`:rsi<35?`RSI ${rsi?.toFixed(1)} is oversold ‚Äî bear momentum may fade, watch for reversal.`:`RSI ${rsi?.toFixed(1)} is healthy ‚Äî trend has room to continue.`});
  tips.push({icon:'üéØ',title:'Target',body:diff>=6||diff<=-6?'Strong setup ‚Äî target 1:2 R:R. Book 50% at +40% premium, trail rest.':'Moderate setup ‚Äî book full at +35% premium. Don\'t overstay.'});
  tips.push({icon:'üóìÔ∏è',title:'Expiry',body:'Use current week expiry for momentum. If VIX > 18, next week gives more time for move to unfold.'});
  return tips;
}

/* ‚îÄ‚îÄ AUTO FETCH ON LOAD ‚îÄ‚îÄ */
window.addEventListener('load', () => {
  setTimeout(fetchLiveData, 600);
});
</script>
</body>
</html>
